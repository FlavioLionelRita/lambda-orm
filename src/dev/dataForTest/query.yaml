name: query
data:
  a:
    id: 1
  b:
    minValue: 10
    from: '1997-01-01'
    to: '1997-12-31'
test:
  - name: query 10
    data: b
    sentences:
      - stage: mongodb
        sentence:
          entity: OrderDetails
          dialect: mongodb
          dataSource: mongodb
          sentence: >-
            [{ "$lookup" :{ "from": "Orders", "localField": "OrderID" ,
            "foreignField": "_id", "as": "o1" }}, { "$lookup" :{ "from":
            "Products", "localField": "ProductID" , "foreignField": "_id", "as":
            "p" }}, { "$lookup" :{ "from": "Categories", "localField":
            "CategoryID" , "foreignField": "_id", "as": "c" }}, { "$match" : {
            "$and" :[{ "$and" :[{ "$gte" :[{ "$arrayElemAt": ["$o1.ShippedDate",
            0] },{{from}}] },{ "$lt" :[{ "$arrayElemAt": ["$o1.ShippedDate", 0]
            },{{to}}] }] },{ "$gt" :["$UnitPrice",{{minValue}}] }] } }, {
            "$project" :{ "_id": 0 , "category":{ "$arrayElemAt":
            ["$c.CategoryName", 0] }, "product":{ "$arrayElemAt":
            ["$p.ProductName", 0] }, "unitPrice":"$UnitPrice",
            "quantity":"$Quantity" }} , { "$sort" :{ "category":1, "product":1 }
            }]
          children: []
    errors: 1
    expression: >-
      OrderDetails.filter(p=>(between(p.order.shippedDate,from,to)&&(p.unitPrice>minValue))).map(p=>{category:p.product.category.name,product:p.product.name,unitPrice:p.unitPrice,quantity:p.quantity}).sort(p=>[p.category,p.product])
    normalizeExpression: >-
      OrderDetails.filter(p=>(between(p.order.shippedDate,from,to)&&(p.unitPrice>minValue))).map(p=>{category:p.product.category.name,product:p.product.name,unitPrice:p.unitPrice,quantity:p.quantity}).sort(p=>[asc(p.category),asc(p.product)])
    model:
      - name: category
        type: string
      - name: product
        type: string
      - name: unitPrice
        type: decimal
      - name: quantity
        type: decimal
    parameters:
      - name: from
        type: datetime
      - name: to
        type: datetime
      - name: minValue
        type: decimal
    constraints:
      entity: OrderDetails
      constraints: []
    metadata:
      name: select
      classtype: Sentence
      children:
        - name: filter
          classtype: Filter
          children:
            - name: '&&'
              classtype: Operator
              children:
                - name: between
                  classtype: FunctionRef
                  children:
                    - name: shippedDate
                      classtype: Field
                      children: []
                      type: datetime
                      entity: Orders
                      alias: o1
                      isRoot: false
                    - name: from
                      classtype: Variable
                      children: []
                      type: datetime
                      number: 1
                    - name: to
                      classtype: Variable
                      children: []
                      type: datetime
                      number: 2
                  type: any
                - name: '>'
                  classtype: Operator
                  children:
                    - name: unitPrice
                      classtype: Field
                      children: []
                      type: decimal
                      entity: OrderDetails
                      alias: o
                      isRoot: true
                    - name: minValue
                      classtype: Variable
                      children: []
                      type: decimal
                      number: 3
                  type: any
              type: any
          type: any
        - name: OrderDetails.o
          classtype: From
          children: []
          type: any
        - name: map
          classtype: Map
          children:
            - name: obj
              classtype: Obj
              children:
                - name: category
                  classtype: KeyValue
                  children:
                    - name: name
                      classtype: Field
                      children: []
                      type: string
                      entity: Categories
                      alias: c
                      isRoot: false
                  type: any
                - name: product
                  classtype: KeyValue
                  children:
                    - name: name
                      classtype: Field
                      children: []
                      type: string
                      entity: Products
                      alias: p
                      isRoot: false
                  type: any
                - name: unitPrice
                  classtype: KeyValue
                  children:
                    - name: unitPrice
                      classtype: Field
                      children: []
                      type: decimal
                      entity: OrderDetails
                      alias: o
                      isRoot: true
                  type: any
                - name: quantity
                  classtype: KeyValue
                  children:
                    - name: quantity
                      classtype: Field
                      children: []
                      type: decimal
                      entity: OrderDetails
                      alias: o
                      isRoot: true
                  type: any
              type: object
          type: any
        - name: sort
          classtype: Sort
          children:
            - name: array
              classtype: List
              children:
                - name: asc
                  classtype: FunctionRef
                  children:
                    - name: category
                      classtype: Field
                      children: []
                      type: string
                      entity: OrderDetails
                      alias: o
                      isRoot: true
                  type: any
                - name: asc
                  classtype: FunctionRef
                  children:
                    - name: product
                      classtype: Field
                      children: []
                      type: string
                      entity: OrderDetails
                      alias: o
                      isRoot: true
                  type: any
              type: array
          type: any
        - name: Orders.o1
          classtype: Join
          children:
            - name: '=='
              classtype: Operator
              children:
                - name: id
                  classtype: Field
                  children: []
                  type: integer
                  entity: Orders
                  alias: o1
                - name: orderId
                  classtype: Field
                  children: []
                  type: integer
                  entity: OrderDetails
                  alias: o
              type: any
          type: any
        - name: Products.p
          classtype: Join
          children:
            - name: '=='
              classtype: Operator
              children:
                - name: id
                  classtype: Field
                  children: []
                  type: integer
                  entity: Products
                  alias: p
                - name: productId
                  classtype: Field
                  children: []
                  type: integer
                  entity: OrderDetails
                  alias: o
              type: any
          type: any
        - name: Categories.c
          classtype: Join
          children:
            - name: '=='
              classtype: Operator
              children:
                - name: id
                  classtype: Field
                  children: []
                  type: integer
                  entity: Categories
                  alias: c
                - name: categoryId
                  classtype: Field
                  children: []
                  type: integer
                  entity: Products
                  alias: p
              type: any
          type: any
      type: any
      columns:
        - name: category
          type: string
        - name: product
          type: string
        - name: unitPrice
          type: decimal
        - name: quantity
          type: decimal
      parameters:
        - name: from
          type: datetime
        - name: to
          type: datetime
        - name: minValue
          type: decimal
      entity: OrderDetails
      constraints: []
    executions:
      - stage: mongodb
        error: >-
          MongoServerError: unknown top level operator: $gte. If you have a
          field name that starts with a '$' symbol, consider using $getField or
          $setField.
errors: 1
