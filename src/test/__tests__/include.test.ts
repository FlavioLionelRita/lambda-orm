import { orm,Helper } from '../../lib'
beforeAll(async () => {
	require('dotenv').config({ path: './test.env' })
	await orm.init()
})
describe('Complete Expression', () => {
	test('include 1', () => {
		const source = 'Orders.filter(p=>(p.id===id)).include(p=>p.customer)'
		const expected = 'Orders.filter(p=>(p.id===id)).map(p=>{id:p.id,customerId:p.customerId,employeeId:p.employeeId,orderDate:p.orderDate,requiredDate:p.requiredDate,shippedDate:p.shippedDate,shipViaId:p.shipViaId,freight:p.freight,name:p.name,address:p.address,city:p.city,region:p.region,postalCode:p.postalCode,country:p.country,__customerId:p.customerId}).include(p=>p.customer.filter(p=>includes(p.id,__parentId)).map(p=>{id:p.id,name:p.name,contact:p.contact,phone:p.phone,address:p.address,city:p.city,region:p.region,postalCode:p.postalCode,country:p.country,__parentId:p.id}))'
		const target = orm.normalize(source)
		expect(expected).toBe(target)
	})
	test('include 2', () => {
		const source = 'Orders.filter(p=>(p.id===id)).include(p=>p.details)'
		const expected = 'Orders.filter(p=>(p.id===id)).map(p=>{id:p.id,customerId:p.customerId,employeeId:p.employeeId,orderDate:p.orderDate,requiredDate:p.requiredDate,shippedDate:p.shippedDate,shipViaId:p.shipViaId,freight:p.freight,name:p.name,address:p.address,city:p.city,region:p.region,postalCode:p.postalCode,country:p.country,__id:p.id}).include(p=>p.details.filter(p=>includes(p.orderId,__parentId)).map(p=>{orderId:p.orderId,productId:p.productId,unitPrice:p.unitPrice,quantity:p.quantity,discount:p.discount,__parentId:p.orderId}))'
		const target = orm.normalize(source)
		expect(expected).toBe(target)
	})
	test('include 3', () => {
		const source = 'Orders.filter(p=>(p.id===id)).include(p=>[p.details,p.customer])'
		const expected = 'Orders.filter(p=>(p.id===id)).map(p=>{id:p.id,customerId:p.customerId,employeeId:p.employeeId,orderDate:p.orderDate,requiredDate:p.requiredDate,shippedDate:p.shippedDate,shipViaId:p.shipViaId,freight:p.freight,name:p.name,address:p.address,city:p.city,region:p.region,postalCode:p.postalCode,country:p.country,__id:p.id,__customerId:p.customerId}).include(p=>[p.details.filter(p=>includes(p.orderId,__parentId)).map(p=>{orderId:p.orderId,productId:p.productId,unitPrice:p.unitPrice,quantity:p.quantity,discount:p.discount,__parentId:p.orderId}),p.customer.filter(p=>includes(p.id,__parentId)).map(p=>{id:p.id,name:p.name,contact:p.contact,phone:p.phone,address:p.address,city:p.city,region:p.region,postalCode:p.postalCode,country:p.country,__parentId:p.id})])'
		const target = orm.normalize(source)
		expect(expected).toBe(target)
	})
	test('include 4', () => {
		const source = 'Orders.filter(p=>(p.id===id)).include(p=>[p.details.include(q=>q.product),p.customer])'
		const expected = 'Orders.filter(p=>(p.id===id)).map(p=>{id:p.id,customerId:p.customerId,employeeId:p.employeeId,orderDate:p.orderDate,requiredDate:p.requiredDate,shippedDate:p.shippedDate,shipViaId:p.shipViaId,freight:p.freight,name:p.name,address:p.address,city:p.city,region:p.region,postalCode:p.postalCode,country:p.country,__id:p.id,__customerId:p.customerId}).include(p=>[p.details.map(p=>{orderId:p.orderId,productId:p.productId,unitPrice:p.unitPrice,quantity:p.quantity,discount:p.discount,__productId:p.productId,__parentId:p.orderId}).filter(p=>includes(p.orderId,__parentId)).include(q=>q.product.filter(p=>includes(p.id,__parentId)).map(p=>{id:p.id,name:p.name,supplierId:p.supplierId,categoryId:p.categoryId,quantity:p.quantity,price:p.price,inStock:p.inStock,onOrder:p.onOrder,reorderLevel:p.reorderLevel,discontinued:p.discontinued,__parentId:p.id})),p.customer.filter(p=>includes(p.id,__parentId)).map(p=>{id:p.id,name:p.name,contact:p.contact,phone:p.phone,address:p.address,city:p.city,region:p.region,postalCode:p.postalCode,country:p.country,__parentId:p.id})])'
		const target = orm.normalize(source)
		expect(expected).toBe(target)
	})
	test('include 5', () => {
		const source = 'Orders.filter(p=>(p.id===id)).include(p=>[p.details.include(q=>q.product.include(p=>p.category)),p.customer])'
		const expected = 'Orders.filter(p=>(p.id===id)).map(p=>{id:p.id,customerId:p.customerId,employeeId:p.employeeId,orderDate:p.orderDate,requiredDate:p.requiredDate,shippedDate:p.shippedDate,shipViaId:p.shipViaId,freight:p.freight,name:p.name,address:p.address,city:p.city,region:p.region,postalCode:p.postalCode,country:p.country,__id:p.id,__customerId:p.customerId}).include(p=>[p.details.map(p=>{orderId:p.orderId,productId:p.productId,unitPrice:p.unitPrice,quantity:p.quantity,discount:p.discount,__productId:p.productId,__parentId:p.orderId}).filter(p=>includes(p.orderId,__parentId)).include(q=>q.product.map(p=>{id:p.id,name:p.name,supplierId:p.supplierId,categoryId:p.categoryId,quantity:p.quantity,price:p.price,inStock:p.inStock,onOrder:p.onOrder,reorderLevel:p.reorderLevel,discontinued:p.discontinued,__categoryId:p.categoryId,__parentId:p.id}).filter(p=>includes(p.id,__parentId)).include(p=>p.category.filter(p=>includes(p.id,__parentId)).map(p=>{id:p.id,name:p.name,description:p.description,__parentId:p.id}))),p.customer.filter(p=>includes(p.id,__parentId)).map(p=>{id:p.id,name:p.name,contact:p.contact,phone:p.phone,address:p.address,city:p.city,region:p.region,postalCode:p.postalCode,country:p.country,__parentId:p.id})])'
		const target = orm.normalize(source)
		expect(expected).toBe(target)
	})
	test('include 6', () => {
		const source = 'Orders.filter(p=>(p.id===id)).include(p=>[p.details.map(p=>{quantity:p.quantity,unitPrice:p.unitPrice,productId:p.productId}),p.customer])'
		const expected = 'Orders.filter(p=>(p.id===id)).map(p=>{id:p.id,customerId:p.customerId,employeeId:p.employeeId,orderDate:p.orderDate,requiredDate:p.requiredDate,shippedDate:p.shippedDate,shipViaId:p.shipViaId,freight:p.freight,name:p.name,address:p.address,city:p.city,region:p.region,postalCode:p.postalCode,country:p.country,__id:p.id,__customerId:p.customerId}).include(p=>[p.details.filter(p=>includes(p.orderId,__parentId)).map(p=>{quantity:p.quantity,unitPrice:p.unitPrice,productId:p.productId,__parentId:p.orderId}),p.customer.filter(p=>includes(p.id,__parentId)).map(p=>{id:p.id,name:p.name,contact:p.contact,phone:p.phone,address:p.address,city:p.city,region:p.region,postalCode:p.postalCode,country:p.country,__parentId:p.id})])'
		const target = orm.normalize(source)
		expect(expected).toBe(target)
	})
	test('include 7', () => {
		const source = 'Orders.filter(p=>(p.id===id)).include(p=>[p.details.include(q=>q.product).map(p=>{quantity:p.quantity,unitPrice:p.unitPrice,productId:p.productId}),p.customer])'
		const expected = 'Orders.filter(p=>(p.id===id)).map(p=>{id:p.id,customerId:p.customerId,employeeId:p.employeeId,orderDate:p.orderDate,requiredDate:p.requiredDate,shippedDate:p.shippedDate,shipViaId:p.shipViaId,freight:p.freight,name:p.name,address:p.address,city:p.city,region:p.region,postalCode:p.postalCode,country:p.country,__id:p.id,__customerId:p.customerId}).include(p=>[p.details.include(q=>q.product.filter(p=>includes(p.id,__parentId)).map(p=>{id:p.id,name:p.name,supplierId:p.supplierId,categoryId:p.categoryId,quantity:p.quantity,price:p.price,inStock:p.inStock,onOrder:p.onOrder,reorderLevel:p.reorderLevel,discontinued:p.discontinued,__parentId:p.id})).filter(p=>includes(p.orderId,__parentId)).map(p=>{quantity:p.quantity,unitPrice:p.unitPrice,productId:p.productId,__productId:p.productId,__parentId:p.orderId}),p.customer.filter(p=>includes(p.id,__parentId)).map(p=>{id:p.id,name:p.name,contact:p.contact,phone:p.phone,address:p.address,city:p.city,region:p.region,postalCode:p.postalCode,country:p.country,__parentId:p.id})])'
		const target = orm.normalize(source)
		expect(expected).toBe(target)
	})
	test('include 8', () => {
		const source = 'Orders.filter(p=>(p.id===id)).include(p=>[p.customer.map(p=>p.name),p.details.include(p=>p.product.include(p=>p.category.map(p=>p.name)).map(p=>p.name)).map(p=>[p.quantity,p.unitPrice])])'
		const expected = 'Orders.filter(p=>(p.id===id)).map(p=>{id:p.id,customerId:p.customerId,employeeId:p.employeeId,orderDate:p.orderDate,requiredDate:p.requiredDate,shippedDate:p.shippedDate,shipViaId:p.shipViaId,freight:p.freight,name:p.name,address:p.address,city:p.city,region:p.region,postalCode:p.postalCode,country:p.country,__customerId:p.customerId,__id:p.id}).include(p=>[p.customer.filter(p=>includes(p.id,__parentId)).map(p=>{name:p.name,__parentId:p.id}),p.details.include(p=>p.product.include(p=>p.category.filter(p=>includes(p.id,__parentId)).map(p=>{name:p.name,__parentId:p.id})).filter(p=>includes(p.id,__parentId)).map(p=>{name:p.name,__categoryId:p.categoryId,__parentId:p.id})).filter(p=>includes(p.orderId,__parentId)).map(p=>{quantity:p.quantity,unitPrice:p.unitPrice,__productId:p.productId,__parentId:p.orderId})])'
		const target = orm.normalize(source)
		expect(expected).toBe(target)
	})
})
describe('Metadata', () => {
	test('include 1', async () => {
		const expression = 'Orders.filter(p=>(p.id===id)).include(p=>p.customer)'
		const modelExpected :any= [{"name":"id","type":"integer"},{"name":"customerId","type":"string"},{"name":"employeeId","type":"integer"},{"name":"orderDate","type":"datetime"},{"name":"requiredDate","type":"datetime"},{"name":"shippedDate","type":"datetime"},{"name":"shipViaId","type":"integer"},{"name":"freight","type":"decimal"},{"name":"name","type":"string"},{"name":"address","type":"string"},{"name":"city","type":"string"},{"name":"region","type":"string"},{"name":"postalCode","type":"string"},{"name":"country","type":"string"},{"name":"customer","type":"Customers","childs":[{"name":"id","type":"string"},{"name":"name","type":"string"},{"name":"contact","type":"string"},{"name":"phone","type":"string"},{"name":"address","type":"string"},{"name":"city","type":"string"},{"name":"region","type":"string"},{"name":"postalCode","type":"string"},{"name":"country","type":"string"}]}]
		const parametersExpected:any = [{"name":"id","type":"integer"},{"name":"customer","type":"Customers","childs":[{"name":"__parentId","type":"array"}]}]
		const metadataExpected :any= {"name":"select","type":"Sentence","children":[{"name":"filter","type":"Filter","children":[{"name":"===","type":"Operator","children":[{"name":"id","type":"Field","children":[],"entity":"Orders","alias":"o"},{"name":"id","type":"Variable","children":[],"number":1}]}]},{"name":"Orders.o","type":"From","children":[]},{"name":"map","type":"Map","children":[{"name":"obj","type":"Obj","children":[{"name":"id","type":"KeyValue","children":[{"name":"id","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"customerId","type":"KeyValue","children":[{"name":"customerId","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"employeeId","type":"KeyValue","children":[{"name":"employeeId","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"orderDate","type":"KeyValue","children":[{"name":"orderDate","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"requiredDate","type":"KeyValue","children":[{"name":"requiredDate","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"shippedDate","type":"KeyValue","children":[{"name":"shippedDate","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"shipViaId","type":"KeyValue","children":[{"name":"shipViaId","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"freight","type":"KeyValue","children":[{"name":"freight","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"name","type":"KeyValue","children":[{"name":"name","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"address","type":"KeyValue","children":[{"name":"address","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"city","type":"KeyValue","children":[{"name":"city","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"region","type":"KeyValue","children":[{"name":"region","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"postalCode","type":"KeyValue","children":[{"name":"postalCode","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"country","type":"KeyValue","children":[{"name":"country","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"__customerId","type":"KeyValue","children":[{"name":"customerId","type":"Field","children":[],"entity":"Orders","alias":"o"}]}]}]},{"name":"customer","type":"SentenceInclude","children":[{"name":"select","type":"Sentence","children":[{"name":"filter","type":"Filter","children":[{"name":"includes","type":"FunctionRef","children":[{"name":"id","type":"Field","children":[],"entity":"Customers","alias":"c"},{"name":"__parentId","type":"Variable","children":[],"number":1}]}]},{"name":"Customers.c","type":"From","children":[]},{"name":"map","type":"Map","children":[{"name":"obj","type":"Obj","children":[{"name":"id","type":"KeyValue","children":[{"name":"id","type":"Field","children":[],"entity":"Customers","alias":"c"}]},{"name":"name","type":"KeyValue","children":[{"name":"name","type":"Field","children":[],"entity":"Customers","alias":"c"}]},{"name":"contact","type":"KeyValue","children":[{"name":"contact","type":"Field","children":[],"entity":"Customers","alias":"c"}]},{"name":"phone","type":"KeyValue","children":[{"name":"phone","type":"Field","children":[],"entity":"Customers","alias":"c"}]},{"name":"address","type":"KeyValue","children":[{"name":"address","type":"Field","children":[],"entity":"Customers","alias":"c"}]},{"name":"city","type":"KeyValue","children":[{"name":"city","type":"Field","children":[],"entity":"Customers","alias":"c"}]},{"name":"region","type":"KeyValue","children":[{"name":"region","type":"Field","children":[],"entity":"Customers","alias":"c"}]},{"name":"postalCode","type":"KeyValue","children":[{"name":"postalCode","type":"Field","children":[],"entity":"Customers","alias":"c"}]},{"name":"country","type":"KeyValue","children":[{"name":"country","type":"Field","children":[],"entity":"Customers","alias":"c"}]},{"name":"__parentId","type":"KeyValue","children":[{"name":"id","type":"Field","children":[],"entity":"Customers","alias":"c"}]}]}]}],"fields":[{"name":"id","type":"string"},{"name":"name","type":"string"},{"name":"contact","type":"string"},{"name":"phone","type":"string"},{"name":"address","type":"string"},{"name":"city","type":"string"},{"name":"region","type":"string"},{"name":"postalCode","type":"string"},{"name":"country","type":"string"},{"name":"__parentId","type":"string"}],"parameters":[{"name":"__parentId","type":"array"}],"entity":"Customers"}],"relation":{"name":"customer","from":"customerId","entity":"Customers","to":"id","target":"orders","targetComposite":true,"type":"oneToMany","weak":false}}],"fields":[{"name":"id","type":"integer"},{"name":"customerId","type":"string"},{"name":"employeeId","type":"integer"},{"name":"orderDate","type":"datetime"},{"name":"requiredDate","type":"datetime"},{"name":"shippedDate","type":"datetime"},{"name":"shipViaId","type":"integer"},{"name":"freight","type":"decimal"},{"name":"name","type":"string"},{"name":"address","type":"string"},{"name":"city","type":"string"},{"name":"region","type":"string"},{"name":"postalCode","type":"string"},{"name":"country","type":"string"},{"name":"__customerId","type":"string"}],"parameters":[{"name":"id","type":"integer"}],"entity":"Orders"}
		const constraintsExpected :any= {"entity":"Orders","constraints":[],"childs":[{"entity":"Customers","constraints":[]}]}
		const model = orm.model(expression)
		const parameters = orm.parameters(expression)
		const constraints = orm.constraints(expression)
		const metadata = orm.metadata(expression)
		expect(modelExpected).toStrictEqual(model)
		expect(metadataExpected.fields).toStrictEqual(metadata.fields)
		expect(parametersExpected).toStrictEqual(parameters)
		expect(constraintsExpected).toStrictEqual(constraints)
	})
	test('include 2', async () => {
		const expression = 'Orders.filter(p=>(p.id===id)).include(p=>p.details)'
		const modelExpected :any= [{"name":"id","type":"integer"},{"name":"customerId","type":"string"},{"name":"employeeId","type":"integer"},{"name":"orderDate","type":"datetime"},{"name":"requiredDate","type":"datetime"},{"name":"shippedDate","type":"datetime"},{"name":"shipViaId","type":"integer"},{"name":"freight","type":"decimal"},{"name":"name","type":"string"},{"name":"address","type":"string"},{"name":"city","type":"string"},{"name":"region","type":"string"},{"name":"postalCode","type":"string"},{"name":"country","type":"string"},{"name":"details","type":"OrderDetails[]","childs":[{"name":"orderId","type":"integer"},{"name":"productId","type":"integer"},{"name":"unitPrice","type":"decimal"},{"name":"quantity","type":"decimal"},{"name":"discount","type":"decimal"}]}]
		const parametersExpected:any = [{"name":"id","type":"integer"},{"name":"details","type":"OrderDetails","childs":[{"name":"__parentId","type":"array"}]}]
		const metadataExpected :any= {"name":"select","type":"Sentence","children":[{"name":"filter","type":"Filter","children":[{"name":"===","type":"Operator","children":[{"name":"id","type":"Field","children":[],"entity":"Orders","alias":"o"},{"name":"id","type":"Variable","children":[],"number":1}]}]},{"name":"Orders.o","type":"From","children":[]},{"name":"map","type":"Map","children":[{"name":"obj","type":"Obj","children":[{"name":"id","type":"KeyValue","children":[{"name":"id","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"customerId","type":"KeyValue","children":[{"name":"customerId","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"employeeId","type":"KeyValue","children":[{"name":"employeeId","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"orderDate","type":"KeyValue","children":[{"name":"orderDate","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"requiredDate","type":"KeyValue","children":[{"name":"requiredDate","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"shippedDate","type":"KeyValue","children":[{"name":"shippedDate","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"shipViaId","type":"KeyValue","children":[{"name":"shipViaId","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"freight","type":"KeyValue","children":[{"name":"freight","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"name","type":"KeyValue","children":[{"name":"name","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"address","type":"KeyValue","children":[{"name":"address","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"city","type":"KeyValue","children":[{"name":"city","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"region","type":"KeyValue","children":[{"name":"region","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"postalCode","type":"KeyValue","children":[{"name":"postalCode","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"country","type":"KeyValue","children":[{"name":"country","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"__id","type":"KeyValue","children":[{"name":"id","type":"Field","children":[],"entity":"Orders","alias":"o"}]}]}]},{"name":"details","type":"SentenceInclude","children":[{"name":"select","type":"Sentence","children":[{"name":"filter","type":"Filter","children":[{"name":"includes","type":"FunctionRef","children":[{"name":"orderId","type":"Field","children":[],"entity":"OrderDetails","alias":"o1"},{"name":"__parentId","type":"Variable","children":[],"number":1}]}]},{"name":"OrderDetails.o1","type":"From","children":[]},{"name":"map","type":"Map","children":[{"name":"obj","type":"Obj","children":[{"name":"orderId","type":"KeyValue","children":[{"name":"orderId","type":"Field","children":[],"entity":"OrderDetails","alias":"o1"}]},{"name":"productId","type":"KeyValue","children":[{"name":"productId","type":"Field","children":[],"entity":"OrderDetails","alias":"o1"}]},{"name":"unitPrice","type":"KeyValue","children":[{"name":"unitPrice","type":"Field","children":[],"entity":"OrderDetails","alias":"o1"}]},{"name":"quantity","type":"KeyValue","children":[{"name":"quantity","type":"Field","children":[],"entity":"OrderDetails","alias":"o1"}]},{"name":"discount","type":"KeyValue","children":[{"name":"discount","type":"Field","children":[],"entity":"OrderDetails","alias":"o1"}]},{"name":"__parentId","type":"KeyValue","children":[{"name":"orderId","type":"Field","children":[],"entity":"OrderDetails","alias":"o1"}]}]}]}],"fields":[{"name":"orderId","type":"integer"},{"name":"productId","type":"integer"},{"name":"unitPrice","type":"decimal"},{"name":"quantity","type":"decimal"},{"name":"discount","type":"decimal"},{"name":"__parentId","type":"integer"}],"parameters":[{"name":"__parentId","type":"array"}],"entity":"OrderDetails"}],"relation":{"name":"details","type":"manyToOne","composite":true,"from":"id","entity":"OrderDetails","weak":true,"to":"orderId","target":"order"}}],"fields":[{"name":"id","type":"integer"},{"name":"customerId","type":"string"},{"name":"employeeId","type":"integer"},{"name":"orderDate","type":"datetime"},{"name":"requiredDate","type":"datetime"},{"name":"shippedDate","type":"datetime"},{"name":"shipViaId","type":"integer"},{"name":"freight","type":"decimal"},{"name":"name","type":"string"},{"name":"address","type":"string"},{"name":"city","type":"string"},{"name":"region","type":"string"},{"name":"postalCode","type":"string"},{"name":"country","type":"string"},{"name":"__id","type":"integer"}],"parameters":[{"name":"id","type":"integer"}],"entity":"Orders"}
		const constraintsExpected :any= {"entity":"Orders","constraints":[],"childs":[{"entity":"OrderDetails","constraints":[]}]}
		const model = orm.model(expression)
		const parameters = orm.parameters(expression)
		const constraints = orm.constraints(expression)
		const metadata = orm.metadata(expression)
		expect(modelExpected).toStrictEqual(model)
		expect(metadataExpected.fields).toStrictEqual(metadata.fields)
		expect(parametersExpected).toStrictEqual(parameters)
		expect(constraintsExpected).toStrictEqual(constraints)
	})
	test('include 3', async () => {
		const expression = 'Orders.filter(p=>(p.id===id)).include(p=>[p.details,p.customer])'
		const modelExpected :any= [{"name":"id","type":"integer"},{"name":"customerId","type":"string"},{"name":"employeeId","type":"integer"},{"name":"orderDate","type":"datetime"},{"name":"requiredDate","type":"datetime"},{"name":"shippedDate","type":"datetime"},{"name":"shipViaId","type":"integer"},{"name":"freight","type":"decimal"},{"name":"name","type":"string"},{"name":"address","type":"string"},{"name":"city","type":"string"},{"name":"region","type":"string"},{"name":"postalCode","type":"string"},{"name":"country","type":"string"},{"name":"details","type":"OrderDetails[]","childs":[{"name":"orderId","type":"integer"},{"name":"productId","type":"integer"},{"name":"unitPrice","type":"decimal"},{"name":"quantity","type":"decimal"},{"name":"discount","type":"decimal"}]},{"name":"customer","type":"Customers","childs":[{"name":"id","type":"string"},{"name":"name","type":"string"},{"name":"contact","type":"string"},{"name":"phone","type":"string"},{"name":"address","type":"string"},{"name":"city","type":"string"},{"name":"region","type":"string"},{"name":"postalCode","type":"string"},{"name":"country","type":"string"}]}]
		const parametersExpected:any = [{"name":"id","type":"integer"},{"name":"details","type":"OrderDetails","childs":[{"name":"__parentId","type":"array"}]},{"name":"customer","type":"Customers","childs":[{"name":"__parentId","type":"array"}]}]
		const metadataExpected :any= {"name":"select","type":"Sentence","children":[{"name":"filter","type":"Filter","children":[{"name":"===","type":"Operator","children":[{"name":"id","type":"Field","children":[],"entity":"Orders","alias":"o"},{"name":"id","type":"Variable","children":[],"number":1}]}]},{"name":"Orders.o","type":"From","children":[]},{"name":"map","type":"Map","children":[{"name":"obj","type":"Obj","children":[{"name":"id","type":"KeyValue","children":[{"name":"id","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"customerId","type":"KeyValue","children":[{"name":"customerId","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"employeeId","type":"KeyValue","children":[{"name":"employeeId","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"orderDate","type":"KeyValue","children":[{"name":"orderDate","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"requiredDate","type":"KeyValue","children":[{"name":"requiredDate","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"shippedDate","type":"KeyValue","children":[{"name":"shippedDate","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"shipViaId","type":"KeyValue","children":[{"name":"shipViaId","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"freight","type":"KeyValue","children":[{"name":"freight","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"name","type":"KeyValue","children":[{"name":"name","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"address","type":"KeyValue","children":[{"name":"address","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"city","type":"KeyValue","children":[{"name":"city","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"region","type":"KeyValue","children":[{"name":"region","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"postalCode","type":"KeyValue","children":[{"name":"postalCode","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"country","type":"KeyValue","children":[{"name":"country","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"__id","type":"KeyValue","children":[{"name":"id","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"__customerId","type":"KeyValue","children":[{"name":"customerId","type":"Field","children":[],"entity":"Orders","alias":"o"}]}]}]},{"name":"details","type":"SentenceInclude","children":[{"name":"select","type":"Sentence","children":[{"name":"filter","type":"Filter","children":[{"name":"includes","type":"FunctionRef","children":[{"name":"orderId","type":"Field","children":[],"entity":"OrderDetails","alias":"o1"},{"name":"__parentId","type":"Variable","children":[],"number":1}]}]},{"name":"OrderDetails.o1","type":"From","children":[]},{"name":"map","type":"Map","children":[{"name":"obj","type":"Obj","children":[{"name":"orderId","type":"KeyValue","children":[{"name":"orderId","type":"Field","children":[],"entity":"OrderDetails","alias":"o1"}]},{"name":"productId","type":"KeyValue","children":[{"name":"productId","type":"Field","children":[],"entity":"OrderDetails","alias":"o1"}]},{"name":"unitPrice","type":"KeyValue","children":[{"name":"unitPrice","type":"Field","children":[],"entity":"OrderDetails","alias":"o1"}]},{"name":"quantity","type":"KeyValue","children":[{"name":"quantity","type":"Field","children":[],"entity":"OrderDetails","alias":"o1"}]},{"name":"discount","type":"KeyValue","children":[{"name":"discount","type":"Field","children":[],"entity":"OrderDetails","alias":"o1"}]},{"name":"__parentId","type":"KeyValue","children":[{"name":"orderId","type":"Field","children":[],"entity":"OrderDetails","alias":"o1"}]}]}]}],"fields":[{"name":"orderId","type":"integer"},{"name":"productId","type":"integer"},{"name":"unitPrice","type":"decimal"},{"name":"quantity","type":"decimal"},{"name":"discount","type":"decimal"},{"name":"__parentId","type":"integer"}],"parameters":[{"name":"__parentId","type":"array"}],"entity":"OrderDetails"}],"relation":{"name":"details","type":"manyToOne","composite":true,"from":"id","entity":"OrderDetails","weak":true,"to":"orderId","target":"order"}},{"name":"customer","type":"SentenceInclude","children":[{"name":"select","type":"Sentence","children":[{"name":"filter","type":"Filter","children":[{"name":"includes","type":"FunctionRef","children":[{"name":"id","type":"Field","children":[],"entity":"Customers","alias":"c"},{"name":"__parentId","type":"Variable","children":[],"number":1}]}]},{"name":"Customers.c","type":"From","children":[]},{"name":"map","type":"Map","children":[{"name":"obj","type":"Obj","children":[{"name":"id","type":"KeyValue","children":[{"name":"id","type":"Field","children":[],"entity":"Customers","alias":"c"}]},{"name":"name","type":"KeyValue","children":[{"name":"name","type":"Field","children":[],"entity":"Customers","alias":"c"}]},{"name":"contact","type":"KeyValue","children":[{"name":"contact","type":"Field","children":[],"entity":"Customers","alias":"c"}]},{"name":"phone","type":"KeyValue","children":[{"name":"phone","type":"Field","children":[],"entity":"Customers","alias":"c"}]},{"name":"address","type":"KeyValue","children":[{"name":"address","type":"Field","children":[],"entity":"Customers","alias":"c"}]},{"name":"city","type":"KeyValue","children":[{"name":"city","type":"Field","children":[],"entity":"Customers","alias":"c"}]},{"name":"region","type":"KeyValue","children":[{"name":"region","type":"Field","children":[],"entity":"Customers","alias":"c"}]},{"name":"postalCode","type":"KeyValue","children":[{"name":"postalCode","type":"Field","children":[],"entity":"Customers","alias":"c"}]},{"name":"country","type":"KeyValue","children":[{"name":"country","type":"Field","children":[],"entity":"Customers","alias":"c"}]},{"name":"__parentId","type":"KeyValue","children":[{"name":"id","type":"Field","children":[],"entity":"Customers","alias":"c"}]}]}]}],"fields":[{"name":"id","type":"string"},{"name":"name","type":"string"},{"name":"contact","type":"string"},{"name":"phone","type":"string"},{"name":"address","type":"string"},{"name":"city","type":"string"},{"name":"region","type":"string"},{"name":"postalCode","type":"string"},{"name":"country","type":"string"},{"name":"__parentId","type":"string"}],"parameters":[{"name":"__parentId","type":"array"}],"entity":"Customers"}],"relation":{"name":"customer","from":"customerId","entity":"Customers","to":"id","target":"orders","targetComposite":true,"type":"oneToMany","weak":false}}],"fields":[{"name":"id","type":"integer"},{"name":"customerId","type":"string"},{"name":"employeeId","type":"integer"},{"name":"orderDate","type":"datetime"},{"name":"requiredDate","type":"datetime"},{"name":"shippedDate","type":"datetime"},{"name":"shipViaId","type":"integer"},{"name":"freight","type":"decimal"},{"name":"name","type":"string"},{"name":"address","type":"string"},{"name":"city","type":"string"},{"name":"region","type":"string"},{"name":"postalCode","type":"string"},{"name":"country","type":"string"},{"name":"__id","type":"integer"},{"name":"__customerId","type":"string"}],"parameters":[{"name":"id","type":"integer"}],"entity":"Orders"}
		const constraintsExpected :any= {"entity":"Orders","constraints":[],"childs":[{"entity":"OrderDetails","constraints":[]},{"entity":"Customers","constraints":[]}]}
		const model = orm.model(expression)
		const parameters = orm.parameters(expression)
		const constraints = orm.constraints(expression)
		const metadata = orm.metadata(expression)
		expect(modelExpected).toStrictEqual(model)
		expect(metadataExpected.fields).toStrictEqual(metadata.fields)
		expect(parametersExpected).toStrictEqual(parameters)
		expect(constraintsExpected).toStrictEqual(constraints)
	})
	test('include 4', async () => {
		const expression = 'Orders.filter(p=>(p.id===id)).include(p=>[p.details.include(q=>q.product),p.customer])'
		const modelExpected :any= [{"name":"id","type":"integer"},{"name":"customerId","type":"string"},{"name":"employeeId","type":"integer"},{"name":"orderDate","type":"datetime"},{"name":"requiredDate","type":"datetime"},{"name":"shippedDate","type":"datetime"},{"name":"shipViaId","type":"integer"},{"name":"freight","type":"decimal"},{"name":"name","type":"string"},{"name":"address","type":"string"},{"name":"city","type":"string"},{"name":"region","type":"string"},{"name":"postalCode","type":"string"},{"name":"country","type":"string"},{"name":"details","type":"OrderDetails[]","childs":[{"name":"orderId","type":"integer"},{"name":"productId","type":"integer"},{"name":"unitPrice","type":"decimal"},{"name":"quantity","type":"decimal"},{"name":"discount","type":"decimal"},{"name":"product","type":"Products","childs":[{"name":"id","type":"integer"},{"name":"name","type":"string"},{"name":"supplierId","type":"integer"},{"name":"categoryId","type":"integer"},{"name":"quantity","type":"string"},{"name":"price","type":"decimal"},{"name":"inStock","type":"decimal"},{"name":"onOrder","type":"decimal"},{"name":"reorderLevel","type":"decimal"},{"name":"discontinued","type":"boolean"}]}]},{"name":"customer","type":"Customers","childs":[{"name":"id","type":"string"},{"name":"name","type":"string"},{"name":"contact","type":"string"},{"name":"phone","type":"string"},{"name":"address","type":"string"},{"name":"city","type":"string"},{"name":"region","type":"string"},{"name":"postalCode","type":"string"},{"name":"country","type":"string"}]}]
		const parametersExpected:any = [{"name":"id","type":"integer"},{"name":"details","type":"OrderDetails","childs":[{"name":"__parentId","type":"array"},{"name":"product","type":"Products","childs":[{"name":"__parentId","type":"array"}]}]},{"name":"customer","type":"Customers","childs":[{"name":"__parentId","type":"array"}]}]
		const metadataExpected :any= {"name":"select","type":"Sentence","children":[{"name":"filter","type":"Filter","children":[{"name":"===","type":"Operator","children":[{"name":"id","type":"Field","children":[],"entity":"Orders","alias":"o"},{"name":"id","type":"Variable","children":[],"number":1}]}]},{"name":"Orders.o","type":"From","children":[]},{"name":"map","type":"Map","children":[{"name":"obj","type":"Obj","children":[{"name":"id","type":"KeyValue","children":[{"name":"id","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"customerId","type":"KeyValue","children":[{"name":"customerId","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"employeeId","type":"KeyValue","children":[{"name":"employeeId","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"orderDate","type":"KeyValue","children":[{"name":"orderDate","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"requiredDate","type":"KeyValue","children":[{"name":"requiredDate","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"shippedDate","type":"KeyValue","children":[{"name":"shippedDate","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"shipViaId","type":"KeyValue","children":[{"name":"shipViaId","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"freight","type":"KeyValue","children":[{"name":"freight","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"name","type":"KeyValue","children":[{"name":"name","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"address","type":"KeyValue","children":[{"name":"address","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"city","type":"KeyValue","children":[{"name":"city","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"region","type":"KeyValue","children":[{"name":"region","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"postalCode","type":"KeyValue","children":[{"name":"postalCode","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"country","type":"KeyValue","children":[{"name":"country","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"__id","type":"KeyValue","children":[{"name":"id","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"__customerId","type":"KeyValue","children":[{"name":"customerId","type":"Field","children":[],"entity":"Orders","alias":"o"}]}]}]},{"name":"details","type":"SentenceInclude","children":[{"name":"select","type":"Sentence","children":[{"name":"filter","type":"Filter","children":[{"name":"includes","type":"FunctionRef","children":[{"name":"orderId","type":"Field","children":[],"entity":"OrderDetails","alias":"o1"},{"name":"__parentId","type":"Variable","children":[],"number":1}]}]},{"name":"OrderDetails.o1","type":"From","children":[]},{"name":"map","type":"Map","children":[{"name":"obj","type":"Obj","children":[{"name":"orderId","type":"KeyValue","children":[{"name":"orderId","type":"Field","children":[],"entity":"OrderDetails","alias":"o1"}]},{"name":"productId","type":"KeyValue","children":[{"name":"productId","type":"Field","children":[],"entity":"OrderDetails","alias":"o1"}]},{"name":"unitPrice","type":"KeyValue","children":[{"name":"unitPrice","type":"Field","children":[],"entity":"OrderDetails","alias":"o1"}]},{"name":"quantity","type":"KeyValue","children":[{"name":"quantity","type":"Field","children":[],"entity":"OrderDetails","alias":"o1"}]},{"name":"discount","type":"KeyValue","children":[{"name":"discount","type":"Field","children":[],"entity":"OrderDetails","alias":"o1"}]},{"name":"__productId","type":"KeyValue","children":[{"name":"productId","type":"Field","children":[],"entity":"OrderDetails","alias":"o1"}]},{"name":"__parentId","type":"KeyValue","children":[{"name":"orderId","type":"Field","children":[],"entity":"OrderDetails","alias":"o1"}]}]}]},{"name":"product","type":"SentenceInclude","children":[{"name":"select","type":"Sentence","children":[{"name":"filter","type":"Filter","children":[{"name":"includes","type":"FunctionRef","children":[{"name":"id","type":"Field","children":[],"entity":"Products","alias":"p"},{"name":"__parentId","type":"Variable","children":[],"number":1}]}]},{"name":"Products.p","type":"From","children":[]},{"name":"map","type":"Map","children":[{"name":"obj","type":"Obj","children":[{"name":"id","type":"KeyValue","children":[{"name":"id","type":"Field","children":[],"entity":"Products","alias":"p"}]},{"name":"name","type":"KeyValue","children":[{"name":"name","type":"Field","children":[],"entity":"Products","alias":"p"}]},{"name":"supplierId","type":"KeyValue","children":[{"name":"supplierId","type":"Field","children":[],"entity":"Products","alias":"p"}]},{"name":"categoryId","type":"KeyValue","children":[{"name":"categoryId","type":"Field","children":[],"entity":"Products","alias":"p"}]},{"name":"quantity","type":"KeyValue","children":[{"name":"quantity","type":"Field","children":[],"entity":"Products","alias":"p"}]},{"name":"price","type":"KeyValue","children":[{"name":"price","type":"Field","children":[],"entity":"Products","alias":"p"}]},{"name":"inStock","type":"KeyValue","children":[{"name":"inStock","type":"Field","children":[],"entity":"Products","alias":"p"}]},{"name":"onOrder","type":"KeyValue","children":[{"name":"onOrder","type":"Field","children":[],"entity":"Products","alias":"p"}]},{"name":"reorderLevel","type":"KeyValue","children":[{"name":"reorderLevel","type":"Field","children":[],"entity":"Products","alias":"p"}]},{"name":"discontinued","type":"KeyValue","children":[{"name":"discontinued","type":"Field","children":[],"entity":"Products","alias":"p"}]},{"name":"__parentId","type":"KeyValue","children":[{"name":"id","type":"Field","children":[],"entity":"Products","alias":"p"}]}]}]}],"fields":[{"name":"id","type":"integer"},{"name":"name","type":"string"},{"name":"supplierId","type":"integer"},{"name":"categoryId","type":"integer"},{"name":"quantity","type":"string"},{"name":"price","type":"decimal"},{"name":"inStock","type":"decimal"},{"name":"onOrder","type":"decimal"},{"name":"reorderLevel","type":"decimal"},{"name":"discontinued","type":"boolean"},{"name":"__parentId","type":"integer"}],"parameters":[{"name":"__parentId","type":"array"}],"entity":"Products"}],"relation":{"name":"product","from":"productId","entity":"Products","to":"id","target":"orderDetails","type":"oneToMany","weak":false}}],"fields":[{"name":"orderId","type":"integer"},{"name":"productId","type":"integer"},{"name":"unitPrice","type":"decimal"},{"name":"quantity","type":"decimal"},{"name":"discount","type":"decimal"},{"name":"__productId","type":"integer"},{"name":"__parentId","type":"integer"}],"parameters":[{"name":"__parentId","type":"array"}],"entity":"OrderDetails"}],"relation":{"name":"details","type":"manyToOne","composite":true,"from":"id","entity":"OrderDetails","weak":true,"to":"orderId","target":"order"}},{"name":"customer","type":"SentenceInclude","children":[{"name":"select","type":"Sentence","children":[{"name":"filter","type":"Filter","children":[{"name":"includes","type":"FunctionRef","children":[{"name":"id","type":"Field","children":[],"entity":"Customers","alias":"c"},{"name":"__parentId","type":"Variable","children":[],"number":1}]}]},{"name":"Customers.c","type":"From","children":[]},{"name":"map","type":"Map","children":[{"name":"obj","type":"Obj","children":[{"name":"id","type":"KeyValue","children":[{"name":"id","type":"Field","children":[],"entity":"Customers","alias":"c"}]},{"name":"name","type":"KeyValue","children":[{"name":"name","type":"Field","children":[],"entity":"Customers","alias":"c"}]},{"name":"contact","type":"KeyValue","children":[{"name":"contact","type":"Field","children":[],"entity":"Customers","alias":"c"}]},{"name":"phone","type":"KeyValue","children":[{"name":"phone","type":"Field","children":[],"entity":"Customers","alias":"c"}]},{"name":"address","type":"KeyValue","children":[{"name":"address","type":"Field","children":[],"entity":"Customers","alias":"c"}]},{"name":"city","type":"KeyValue","children":[{"name":"city","type":"Field","children":[],"entity":"Customers","alias":"c"}]},{"name":"region","type":"KeyValue","children":[{"name":"region","type":"Field","children":[],"entity":"Customers","alias":"c"}]},{"name":"postalCode","type":"KeyValue","children":[{"name":"postalCode","type":"Field","children":[],"entity":"Customers","alias":"c"}]},{"name":"country","type":"KeyValue","children":[{"name":"country","type":"Field","children":[],"entity":"Customers","alias":"c"}]},{"name":"__parentId","type":"KeyValue","children":[{"name":"id","type":"Field","children":[],"entity":"Customers","alias":"c"}]}]}]}],"fields":[{"name":"id","type":"string"},{"name":"name","type":"string"},{"name":"contact","type":"string"},{"name":"phone","type":"string"},{"name":"address","type":"string"},{"name":"city","type":"string"},{"name":"region","type":"string"},{"name":"postalCode","type":"string"},{"name":"country","type":"string"},{"name":"__parentId","type":"string"}],"parameters":[{"name":"__parentId","type":"array"}],"entity":"Customers"}],"relation":{"name":"customer","from":"customerId","entity":"Customers","to":"id","target":"orders","targetComposite":true,"type":"oneToMany","weak":false}}],"fields":[{"name":"id","type":"integer"},{"name":"customerId","type":"string"},{"name":"employeeId","type":"integer"},{"name":"orderDate","type":"datetime"},{"name":"requiredDate","type":"datetime"},{"name":"shippedDate","type":"datetime"},{"name":"shipViaId","type":"integer"},{"name":"freight","type":"decimal"},{"name":"name","type":"string"},{"name":"address","type":"string"},{"name":"city","type":"string"},{"name":"region","type":"string"},{"name":"postalCode","type":"string"},{"name":"country","type":"string"},{"name":"__id","type":"integer"},{"name":"__customerId","type":"string"}],"parameters":[{"name":"id","type":"integer"}],"entity":"Orders"}
		const constraintsExpected :any= {"entity":"Orders","constraints":[],"childs":[{"entity":"OrderDetails","constraints":[],"childs":[{"entity":"Products","constraints":[]}]},{"entity":"Customers","constraints":[]}]}
		const model = orm.model(expression)
		const parameters = orm.parameters(expression)
		const constraints = orm.constraints(expression)
		const metadata = orm.metadata(expression)
		expect(modelExpected).toStrictEqual(model)
		expect(metadataExpected.fields).toStrictEqual(metadata.fields)
		expect(parametersExpected).toStrictEqual(parameters)
		expect(constraintsExpected).toStrictEqual(constraints)
	})
	test('include 5', async () => {
		const expression = 'Orders.filter(p=>(p.id===id)).include(p=>[p.details.include(q=>q.product.include(p=>p.category)),p.customer])'
		const modelExpected :any= [{"name":"id","type":"integer"},{"name":"customerId","type":"string"},{"name":"employeeId","type":"integer"},{"name":"orderDate","type":"datetime"},{"name":"requiredDate","type":"datetime"},{"name":"shippedDate","type":"datetime"},{"name":"shipViaId","type":"integer"},{"name":"freight","type":"decimal"},{"name":"name","type":"string"},{"name":"address","type":"string"},{"name":"city","type":"string"},{"name":"region","type":"string"},{"name":"postalCode","type":"string"},{"name":"country","type":"string"},{"name":"details","type":"OrderDetails[]","childs":[{"name":"orderId","type":"integer"},{"name":"productId","type":"integer"},{"name":"unitPrice","type":"decimal"},{"name":"quantity","type":"decimal"},{"name":"discount","type":"decimal"},{"name":"product","type":"Products","childs":[{"name":"id","type":"integer"},{"name":"name","type":"string"},{"name":"supplierId","type":"integer"},{"name":"categoryId","type":"integer"},{"name":"quantity","type":"string"},{"name":"price","type":"decimal"},{"name":"inStock","type":"decimal"},{"name":"onOrder","type":"decimal"},{"name":"reorderLevel","type":"decimal"},{"name":"discontinued","type":"boolean"},{"name":"category","type":"Categories","childs":[{"name":"id","type":"integer"},{"name":"name","type":"string"},{"name":"description","type":"string"}]}]}]},{"name":"customer","type":"Customers","childs":[{"name":"id","type":"string"},{"name":"name","type":"string"},{"name":"contact","type":"string"},{"name":"phone","type":"string"},{"name":"address","type":"string"},{"name":"city","type":"string"},{"name":"region","type":"string"},{"name":"postalCode","type":"string"},{"name":"country","type":"string"}]}]
		const parametersExpected:any = [{"name":"id","type":"integer"},{"name":"details","type":"OrderDetails","childs":[{"name":"__parentId","type":"array"},{"name":"product","type":"Products","childs":[{"name":"__parentId","type":"array"},{"name":"category","type":"Categories","childs":[{"name":"__parentId","type":"array"}]}]}]},{"name":"customer","type":"Customers","childs":[{"name":"__parentId","type":"array"}]}]
		const metadataExpected :any= {"name":"select","type":"Sentence","children":[{"name":"filter","type":"Filter","children":[{"name":"===","type":"Operator","children":[{"name":"id","type":"Field","children":[],"entity":"Orders","alias":"o"},{"name":"id","type":"Variable","children":[],"number":1}]}]},{"name":"Orders.o","type":"From","children":[]},{"name":"map","type":"Map","children":[{"name":"obj","type":"Obj","children":[{"name":"id","type":"KeyValue","children":[{"name":"id","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"customerId","type":"KeyValue","children":[{"name":"customerId","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"employeeId","type":"KeyValue","children":[{"name":"employeeId","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"orderDate","type":"KeyValue","children":[{"name":"orderDate","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"requiredDate","type":"KeyValue","children":[{"name":"requiredDate","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"shippedDate","type":"KeyValue","children":[{"name":"shippedDate","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"shipViaId","type":"KeyValue","children":[{"name":"shipViaId","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"freight","type":"KeyValue","children":[{"name":"freight","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"name","type":"KeyValue","children":[{"name":"name","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"address","type":"KeyValue","children":[{"name":"address","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"city","type":"KeyValue","children":[{"name":"city","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"region","type":"KeyValue","children":[{"name":"region","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"postalCode","type":"KeyValue","children":[{"name":"postalCode","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"country","type":"KeyValue","children":[{"name":"country","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"__id","type":"KeyValue","children":[{"name":"id","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"__customerId","type":"KeyValue","children":[{"name":"customerId","type":"Field","children":[],"entity":"Orders","alias":"o"}]}]}]},{"name":"details","type":"SentenceInclude","children":[{"name":"select","type":"Sentence","children":[{"name":"filter","type":"Filter","children":[{"name":"includes","type":"FunctionRef","children":[{"name":"orderId","type":"Field","children":[],"entity":"OrderDetails","alias":"o1"},{"name":"__parentId","type":"Variable","children":[],"number":1}]}]},{"name":"OrderDetails.o1","type":"From","children":[]},{"name":"map","type":"Map","children":[{"name":"obj","type":"Obj","children":[{"name":"orderId","type":"KeyValue","children":[{"name":"orderId","type":"Field","children":[],"entity":"OrderDetails","alias":"o1"}]},{"name":"productId","type":"KeyValue","children":[{"name":"productId","type":"Field","children":[],"entity":"OrderDetails","alias":"o1"}]},{"name":"unitPrice","type":"KeyValue","children":[{"name":"unitPrice","type":"Field","children":[],"entity":"OrderDetails","alias":"o1"}]},{"name":"quantity","type":"KeyValue","children":[{"name":"quantity","type":"Field","children":[],"entity":"OrderDetails","alias":"o1"}]},{"name":"discount","type":"KeyValue","children":[{"name":"discount","type":"Field","children":[],"entity":"OrderDetails","alias":"o1"}]},{"name":"__productId","type":"KeyValue","children":[{"name":"productId","type":"Field","children":[],"entity":"OrderDetails","alias":"o1"}]},{"name":"__parentId","type":"KeyValue","children":[{"name":"orderId","type":"Field","children":[],"entity":"OrderDetails","alias":"o1"}]}]}]},{"name":"product","type":"SentenceInclude","children":[{"name":"select","type":"Sentence","children":[{"name":"filter","type":"Filter","children":[{"name":"includes","type":"FunctionRef","children":[{"name":"id","type":"Field","children":[],"entity":"Products","alias":"p"},{"name":"__parentId","type":"Variable","children":[],"number":1}]}]},{"name":"Products.p","type":"From","children":[]},{"name":"map","type":"Map","children":[{"name":"obj","type":"Obj","children":[{"name":"id","type":"KeyValue","children":[{"name":"id","type":"Field","children":[],"entity":"Products","alias":"p"}]},{"name":"name","type":"KeyValue","children":[{"name":"name","type":"Field","children":[],"entity":"Products","alias":"p"}]},{"name":"supplierId","type":"KeyValue","children":[{"name":"supplierId","type":"Field","children":[],"entity":"Products","alias":"p"}]},{"name":"categoryId","type":"KeyValue","children":[{"name":"categoryId","type":"Field","children":[],"entity":"Products","alias":"p"}]},{"name":"quantity","type":"KeyValue","children":[{"name":"quantity","type":"Field","children":[],"entity":"Products","alias":"p"}]},{"name":"price","type":"KeyValue","children":[{"name":"price","type":"Field","children":[],"entity":"Products","alias":"p"}]},{"name":"inStock","type":"KeyValue","children":[{"name":"inStock","type":"Field","children":[],"entity":"Products","alias":"p"}]},{"name":"onOrder","type":"KeyValue","children":[{"name":"onOrder","type":"Field","children":[],"entity":"Products","alias":"p"}]},{"name":"reorderLevel","type":"KeyValue","children":[{"name":"reorderLevel","type":"Field","children":[],"entity":"Products","alias":"p"}]},{"name":"discontinued","type":"KeyValue","children":[{"name":"discontinued","type":"Field","children":[],"entity":"Products","alias":"p"}]},{"name":"__categoryId","type":"KeyValue","children":[{"name":"categoryId","type":"Field","children":[],"entity":"Products","alias":"p"}]},{"name":"__parentId","type":"KeyValue","children":[{"name":"id","type":"Field","children":[],"entity":"Products","alias":"p"}]}]}]},{"name":"category","type":"SentenceInclude","children":[{"name":"select","type":"Sentence","children":[{"name":"filter","type":"Filter","children":[{"name":"includes","type":"FunctionRef","children":[{"name":"id","type":"Field","children":[],"entity":"Categories","alias":"c"},{"name":"__parentId","type":"Variable","children":[],"number":1}]}]},{"name":"Categories.c","type":"From","children":[]},{"name":"map","type":"Map","children":[{"name":"obj","type":"Obj","children":[{"name":"id","type":"KeyValue","children":[{"name":"id","type":"Field","children":[],"entity":"Categories","alias":"c"}]},{"name":"name","type":"KeyValue","children":[{"name":"name","type":"Field","children":[],"entity":"Categories","alias":"c"}]},{"name":"description","type":"KeyValue","children":[{"name":"description","type":"Field","children":[],"entity":"Categories","alias":"c"}]},{"name":"__parentId","type":"KeyValue","children":[{"name":"id","type":"Field","children":[],"entity":"Categories","alias":"c"}]}]}]}],"fields":[{"name":"id","type":"integer"},{"name":"name","type":"string"},{"name":"description","type":"string"},{"name":"__parentId","type":"integer"}],"parameters":[{"name":"__parentId","type":"array"}],"entity":"Categories"}],"relation":{"name":"category","from":"categoryId","entity":"Categories","to":"id","target":"products","type":"oneToMany","weak":false}}],"fields":[{"name":"id","type":"integer"},{"name":"name","type":"string"},{"name":"supplierId","type":"integer"},{"name":"categoryId","type":"integer"},{"name":"quantity","type":"string"},{"name":"price","type":"decimal"},{"name":"inStock","type":"decimal"},{"name":"onOrder","type":"decimal"},{"name":"reorderLevel","type":"decimal"},{"name":"discontinued","type":"boolean"},{"name":"__categoryId","type":"integer"},{"name":"__parentId","type":"integer"}],"parameters":[{"name":"__parentId","type":"array"}],"entity":"Products"}],"relation":{"name":"product","from":"productId","entity":"Products","to":"id","target":"orderDetails","type":"oneToMany","weak":false}}],"fields":[{"name":"orderId","type":"integer"},{"name":"productId","type":"integer"},{"name":"unitPrice","type":"decimal"},{"name":"quantity","type":"decimal"},{"name":"discount","type":"decimal"},{"name":"__productId","type":"integer"},{"name":"__parentId","type":"integer"}],"parameters":[{"name":"__parentId","type":"array"}],"entity":"OrderDetails"}],"relation":{"name":"details","type":"manyToOne","composite":true,"from":"id","entity":"OrderDetails","weak":true,"to":"orderId","target":"order"}},{"name":"customer","type":"SentenceInclude","children":[{"name":"select","type":"Sentence","children":[{"name":"filter","type":"Filter","children":[{"name":"includes","type":"FunctionRef","children":[{"name":"id","type":"Field","children":[],"entity":"Customers","alias":"c1"},{"name":"__parentId","type":"Variable","children":[],"number":1}]}]},{"name":"Customers.c1","type":"From","children":[]},{"name":"map","type":"Map","children":[{"name":"obj","type":"Obj","children":[{"name":"id","type":"KeyValue","children":[{"name":"id","type":"Field","children":[],"entity":"Customers","alias":"c1"}]},{"name":"name","type":"KeyValue","children":[{"name":"name","type":"Field","children":[],"entity":"Customers","alias":"c1"}]},{"name":"contact","type":"KeyValue","children":[{"name":"contact","type":"Field","children":[],"entity":"Customers","alias":"c1"}]},{"name":"phone","type":"KeyValue","children":[{"name":"phone","type":"Field","children":[],"entity":"Customers","alias":"c1"}]},{"name":"address","type":"KeyValue","children":[{"name":"address","type":"Field","children":[],"entity":"Customers","alias":"c1"}]},{"name":"city","type":"KeyValue","children":[{"name":"city","type":"Field","children":[],"entity":"Customers","alias":"c1"}]},{"name":"region","type":"KeyValue","children":[{"name":"region","type":"Field","children":[],"entity":"Customers","alias":"c1"}]},{"name":"postalCode","type":"KeyValue","children":[{"name":"postalCode","type":"Field","children":[],"entity":"Customers","alias":"c1"}]},{"name":"country","type":"KeyValue","children":[{"name":"country","type":"Field","children":[],"entity":"Customers","alias":"c1"}]},{"name":"__parentId","type":"KeyValue","children":[{"name":"id","type":"Field","children":[],"entity":"Customers","alias":"c1"}]}]}]}],"fields":[{"name":"id","type":"string"},{"name":"name","type":"string"},{"name":"contact","type":"string"},{"name":"phone","type":"string"},{"name":"address","type":"string"},{"name":"city","type":"string"},{"name":"region","type":"string"},{"name":"postalCode","type":"string"},{"name":"country","type":"string"},{"name":"__parentId","type":"string"}],"parameters":[{"name":"__parentId","type":"array"}],"entity":"Customers"}],"relation":{"name":"customer","from":"customerId","entity":"Customers","to":"id","target":"orders","targetComposite":true,"type":"oneToMany","weak":false}}],"fields":[{"name":"id","type":"integer"},{"name":"customerId","type":"string"},{"name":"employeeId","type":"integer"},{"name":"orderDate","type":"datetime"},{"name":"requiredDate","type":"datetime"},{"name":"shippedDate","type":"datetime"},{"name":"shipViaId","type":"integer"},{"name":"freight","type":"decimal"},{"name":"name","type":"string"},{"name":"address","type":"string"},{"name":"city","type":"string"},{"name":"region","type":"string"},{"name":"postalCode","type":"string"},{"name":"country","type":"string"},{"name":"__id","type":"integer"},{"name":"__customerId","type":"string"}],"parameters":[{"name":"id","type":"integer"}],"entity":"Orders"}
		const constraintsExpected :any= {"entity":"Orders","constraints":[],"childs":[{"entity":"OrderDetails","constraints":[],"childs":[{"entity":"Products","constraints":[],"childs":[{"entity":"Categories","constraints":[]}]}]},{"entity":"Customers","constraints":[]}]}
		const model = orm.model(expression)
		const parameters = orm.parameters(expression)
		const constraints = orm.constraints(expression)
		const metadata = orm.metadata(expression)
		expect(modelExpected).toStrictEqual(model)
		expect(metadataExpected.fields).toStrictEqual(metadata.fields)
		expect(parametersExpected).toStrictEqual(parameters)
		expect(constraintsExpected).toStrictEqual(constraints)
	})
	test('include 6', async () => {
		const expression = 'Orders.filter(p=>(p.id===id)).include(p=>[p.details.map(p=>{quantity:p.quantity,unitPrice:p.unitPrice,productId:p.productId}),p.customer])'
		const modelExpected :any= [{"name":"id","type":"integer"},{"name":"customerId","type":"string"},{"name":"employeeId","type":"integer"},{"name":"orderDate","type":"datetime"},{"name":"requiredDate","type":"datetime"},{"name":"shippedDate","type":"datetime"},{"name":"shipViaId","type":"integer"},{"name":"freight","type":"decimal"},{"name":"name","type":"string"},{"name":"address","type":"string"},{"name":"city","type":"string"},{"name":"region","type":"string"},{"name":"postalCode","type":"string"},{"name":"country","type":"string"},{"name":"details","type":"OrderDetails[]","childs":[{"name":"quantity","type":"decimal"},{"name":"unitPrice","type":"decimal"},{"name":"productId","type":"integer"}]},{"name":"customer","type":"Customers","childs":[{"name":"id","type":"string"},{"name":"name","type":"string"},{"name":"contact","type":"string"},{"name":"phone","type":"string"},{"name":"address","type":"string"},{"name":"city","type":"string"},{"name":"region","type":"string"},{"name":"postalCode","type":"string"},{"name":"country","type":"string"}]}]
		const parametersExpected:any = [{"name":"id","type":"integer"},{"name":"details","type":"OrderDetails","childs":[{"name":"__parentId","type":"array"}]},{"name":"customer","type":"Customers","childs":[{"name":"__parentId","type":"array"}]}]
		const metadataExpected :any= {"name":"select","type":"Sentence","children":[{"name":"filter","type":"Filter","children":[{"name":"===","type":"Operator","children":[{"name":"id","type":"Field","children":[],"entity":"Orders","alias":"o"},{"name":"id","type":"Variable","children":[],"number":1}]}]},{"name":"Orders.o","type":"From","children":[]},{"name":"map","type":"Map","children":[{"name":"obj","type":"Obj","children":[{"name":"id","type":"KeyValue","children":[{"name":"id","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"customerId","type":"KeyValue","children":[{"name":"customerId","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"employeeId","type":"KeyValue","children":[{"name":"employeeId","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"orderDate","type":"KeyValue","children":[{"name":"orderDate","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"requiredDate","type":"KeyValue","children":[{"name":"requiredDate","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"shippedDate","type":"KeyValue","children":[{"name":"shippedDate","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"shipViaId","type":"KeyValue","children":[{"name":"shipViaId","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"freight","type":"KeyValue","children":[{"name":"freight","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"name","type":"KeyValue","children":[{"name":"name","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"address","type":"KeyValue","children":[{"name":"address","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"city","type":"KeyValue","children":[{"name":"city","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"region","type":"KeyValue","children":[{"name":"region","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"postalCode","type":"KeyValue","children":[{"name":"postalCode","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"country","type":"KeyValue","children":[{"name":"country","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"__id","type":"KeyValue","children":[{"name":"id","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"__customerId","type":"KeyValue","children":[{"name":"customerId","type":"Field","children":[],"entity":"Orders","alias":"o"}]}]}]},{"name":"details","type":"SentenceInclude","children":[{"name":"select","type":"Sentence","children":[{"name":"filter","type":"Filter","children":[{"name":"includes","type":"FunctionRef","children":[{"name":"orderId","type":"Field","children":[],"entity":"OrderDetails","alias":"o1"},{"name":"__parentId","type":"Variable","children":[],"number":1}]}]},{"name":"OrderDetails.o1","type":"From","children":[]},{"name":"map","type":"Map","children":[{"name":"obj","type":"Obj","children":[{"name":"quantity","type":"KeyValue","children":[{"name":"quantity","type":"Field","children":[],"entity":"OrderDetails","alias":"o1"}]},{"name":"unitPrice","type":"KeyValue","children":[{"name":"unitPrice","type":"Field","children":[],"entity":"OrderDetails","alias":"o1"}]},{"name":"productId","type":"KeyValue","children":[{"name":"productId","type":"Field","children":[],"entity":"OrderDetails","alias":"o1"}]},{"name":"__parentId","type":"KeyValue","children":[{"name":"orderId","type":"Field","children":[],"entity":"OrderDetails","alias":"o1"}]}]}]}],"fields":[{"name":"quantity","type":"decimal"},{"name":"unitPrice","type":"decimal"},{"name":"productId","type":"integer"},{"name":"__parentId","type":"integer"}],"parameters":[{"name":"__parentId","type":"array"}],"entity":"OrderDetails"}],"relation":{"name":"details","type":"manyToOne","composite":true,"from":"id","entity":"OrderDetails","weak":true,"to":"orderId","target":"order"}},{"name":"customer","type":"SentenceInclude","children":[{"name":"select","type":"Sentence","children":[{"name":"filter","type":"Filter","children":[{"name":"includes","type":"FunctionRef","children":[{"name":"id","type":"Field","children":[],"entity":"Customers","alias":"c"},{"name":"__parentId","type":"Variable","children":[],"number":1}]}]},{"name":"Customers.c","type":"From","children":[]},{"name":"map","type":"Map","children":[{"name":"obj","type":"Obj","children":[{"name":"id","type":"KeyValue","children":[{"name":"id","type":"Field","children":[],"entity":"Customers","alias":"c"}]},{"name":"name","type":"KeyValue","children":[{"name":"name","type":"Field","children":[],"entity":"Customers","alias":"c"}]},{"name":"contact","type":"KeyValue","children":[{"name":"contact","type":"Field","children":[],"entity":"Customers","alias":"c"}]},{"name":"phone","type":"KeyValue","children":[{"name":"phone","type":"Field","children":[],"entity":"Customers","alias":"c"}]},{"name":"address","type":"KeyValue","children":[{"name":"address","type":"Field","children":[],"entity":"Customers","alias":"c"}]},{"name":"city","type":"KeyValue","children":[{"name":"city","type":"Field","children":[],"entity":"Customers","alias":"c"}]},{"name":"region","type":"KeyValue","children":[{"name":"region","type":"Field","children":[],"entity":"Customers","alias":"c"}]},{"name":"postalCode","type":"KeyValue","children":[{"name":"postalCode","type":"Field","children":[],"entity":"Customers","alias":"c"}]},{"name":"country","type":"KeyValue","children":[{"name":"country","type":"Field","children":[],"entity":"Customers","alias":"c"}]},{"name":"__parentId","type":"KeyValue","children":[{"name":"id","type":"Field","children":[],"entity":"Customers","alias":"c"}]}]}]}],"fields":[{"name":"id","type":"string"},{"name":"name","type":"string"},{"name":"contact","type":"string"},{"name":"phone","type":"string"},{"name":"address","type":"string"},{"name":"city","type":"string"},{"name":"region","type":"string"},{"name":"postalCode","type":"string"},{"name":"country","type":"string"},{"name":"__parentId","type":"string"}],"parameters":[{"name":"__parentId","type":"array"}],"entity":"Customers"}],"relation":{"name":"customer","from":"customerId","entity":"Customers","to":"id","target":"orders","targetComposite":true,"type":"oneToMany","weak":false}}],"fields":[{"name":"id","type":"integer"},{"name":"customerId","type":"string"},{"name":"employeeId","type":"integer"},{"name":"orderDate","type":"datetime"},{"name":"requiredDate","type":"datetime"},{"name":"shippedDate","type":"datetime"},{"name":"shipViaId","type":"integer"},{"name":"freight","type":"decimal"},{"name":"name","type":"string"},{"name":"address","type":"string"},{"name":"city","type":"string"},{"name":"region","type":"string"},{"name":"postalCode","type":"string"},{"name":"country","type":"string"},{"name":"__id","type":"integer"},{"name":"__customerId","type":"string"}],"parameters":[{"name":"id","type":"integer"}],"entity":"Orders"}
		const constraintsExpected :any= {"entity":"Orders","constraints":[],"childs":[{"entity":"OrderDetails","constraints":[]},{"entity":"Customers","constraints":[]}]}
		const model = orm.model(expression)
		const parameters = orm.parameters(expression)
		const constraints = orm.constraints(expression)
		const metadata = orm.metadata(expression)
		expect(modelExpected).toStrictEqual(model)
		expect(metadataExpected.fields).toStrictEqual(metadata.fields)
		expect(parametersExpected).toStrictEqual(parameters)
		expect(constraintsExpected).toStrictEqual(constraints)
	})
	test('include 7', async () => {
		const expression = 'Orders.filter(p=>(p.id===id)).include(p=>[p.details.include(q=>q.product).map(p=>{quantity:p.quantity,unitPrice:p.unitPrice,productId:p.productId}),p.customer])'
		const modelExpected :any= [{"name":"id","type":"integer"},{"name":"customerId","type":"string"},{"name":"employeeId","type":"integer"},{"name":"orderDate","type":"datetime"},{"name":"requiredDate","type":"datetime"},{"name":"shippedDate","type":"datetime"},{"name":"shipViaId","type":"integer"},{"name":"freight","type":"decimal"},{"name":"name","type":"string"},{"name":"address","type":"string"},{"name":"city","type":"string"},{"name":"region","type":"string"},{"name":"postalCode","type":"string"},{"name":"country","type":"string"},{"name":"details","type":"OrderDetails[]","childs":[{"name":"quantity","type":"decimal"},{"name":"unitPrice","type":"decimal"},{"name":"productId","type":"integer"},{"name":"product","type":"Products","childs":[{"name":"id","type":"integer"},{"name":"name","type":"string"},{"name":"supplierId","type":"integer"},{"name":"categoryId","type":"integer"},{"name":"quantity","type":"string"},{"name":"price","type":"decimal"},{"name":"inStock","type":"decimal"},{"name":"onOrder","type":"decimal"},{"name":"reorderLevel","type":"decimal"},{"name":"discontinued","type":"boolean"}]}]},{"name":"customer","type":"Customers","childs":[{"name":"id","type":"string"},{"name":"name","type":"string"},{"name":"contact","type":"string"},{"name":"phone","type":"string"},{"name":"address","type":"string"},{"name":"city","type":"string"},{"name":"region","type":"string"},{"name":"postalCode","type":"string"},{"name":"country","type":"string"}]}]
		const parametersExpected:any = [{"name":"id","type":"integer"},{"name":"details","type":"OrderDetails","childs":[{"name":"__parentId","type":"array"},{"name":"product","type":"Products","childs":[{"name":"__parentId","type":"array"}]}]},{"name":"customer","type":"Customers","childs":[{"name":"__parentId","type":"array"}]}]
		const metadataExpected :any= {"name":"select","type":"Sentence","children":[{"name":"filter","type":"Filter","children":[{"name":"===","type":"Operator","children":[{"name":"id","type":"Field","children":[],"entity":"Orders","alias":"o"},{"name":"id","type":"Variable","children":[],"number":1}]}]},{"name":"Orders.o","type":"From","children":[]},{"name":"map","type":"Map","children":[{"name":"obj","type":"Obj","children":[{"name":"id","type":"KeyValue","children":[{"name":"id","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"customerId","type":"KeyValue","children":[{"name":"customerId","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"employeeId","type":"KeyValue","children":[{"name":"employeeId","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"orderDate","type":"KeyValue","children":[{"name":"orderDate","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"requiredDate","type":"KeyValue","children":[{"name":"requiredDate","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"shippedDate","type":"KeyValue","children":[{"name":"shippedDate","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"shipViaId","type":"KeyValue","children":[{"name":"shipViaId","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"freight","type":"KeyValue","children":[{"name":"freight","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"name","type":"KeyValue","children":[{"name":"name","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"address","type":"KeyValue","children":[{"name":"address","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"city","type":"KeyValue","children":[{"name":"city","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"region","type":"KeyValue","children":[{"name":"region","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"postalCode","type":"KeyValue","children":[{"name":"postalCode","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"country","type":"KeyValue","children":[{"name":"country","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"__id","type":"KeyValue","children":[{"name":"id","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"__customerId","type":"KeyValue","children":[{"name":"customerId","type":"Field","children":[],"entity":"Orders","alias":"o"}]}]}]},{"name":"details","type":"SentenceInclude","children":[{"name":"select","type":"Sentence","children":[{"name":"filter","type":"Filter","children":[{"name":"includes","type":"FunctionRef","children":[{"name":"orderId","type":"Field","children":[],"entity":"OrderDetails","alias":"o1"},{"name":"__parentId","type":"Variable","children":[],"number":1}]}]},{"name":"OrderDetails.o1","type":"From","children":[]},{"name":"map","type":"Map","children":[{"name":"obj","type":"Obj","children":[{"name":"quantity","type":"KeyValue","children":[{"name":"quantity","type":"Field","children":[],"entity":"OrderDetails","alias":"o1"}]},{"name":"unitPrice","type":"KeyValue","children":[{"name":"unitPrice","type":"Field","children":[],"entity":"OrderDetails","alias":"o1"}]},{"name":"productId","type":"KeyValue","children":[{"name":"productId","type":"Field","children":[],"entity":"OrderDetails","alias":"o1"}]},{"name":"__productId","type":"KeyValue","children":[{"name":"productId","type":"Field","children":[],"entity":"OrderDetails","alias":"o1"}]},{"name":"__parentId","type":"KeyValue","children":[{"name":"orderId","type":"Field","children":[],"entity":"OrderDetails","alias":"o1"}]}]}]},{"name":"product","type":"SentenceInclude","children":[{"name":"select","type":"Sentence","children":[{"name":"filter","type":"Filter","children":[{"name":"includes","type":"FunctionRef","children":[{"name":"id","type":"Field","children":[],"entity":"Products","alias":"p"},{"name":"__parentId","type":"Variable","children":[],"number":1}]}]},{"name":"Products.p","type":"From","children":[]},{"name":"map","type":"Map","children":[{"name":"obj","type":"Obj","children":[{"name":"id","type":"KeyValue","children":[{"name":"id","type":"Field","children":[],"entity":"Products","alias":"p"}]},{"name":"name","type":"KeyValue","children":[{"name":"name","type":"Field","children":[],"entity":"Products","alias":"p"}]},{"name":"supplierId","type":"KeyValue","children":[{"name":"supplierId","type":"Field","children":[],"entity":"Products","alias":"p"}]},{"name":"categoryId","type":"KeyValue","children":[{"name":"categoryId","type":"Field","children":[],"entity":"Products","alias":"p"}]},{"name":"quantity","type":"KeyValue","children":[{"name":"quantity","type":"Field","children":[],"entity":"Products","alias":"p"}]},{"name":"price","type":"KeyValue","children":[{"name":"price","type":"Field","children":[],"entity":"Products","alias":"p"}]},{"name":"inStock","type":"KeyValue","children":[{"name":"inStock","type":"Field","children":[],"entity":"Products","alias":"p"}]},{"name":"onOrder","type":"KeyValue","children":[{"name":"onOrder","type":"Field","children":[],"entity":"Products","alias":"p"}]},{"name":"reorderLevel","type":"KeyValue","children":[{"name":"reorderLevel","type":"Field","children":[],"entity":"Products","alias":"p"}]},{"name":"discontinued","type":"KeyValue","children":[{"name":"discontinued","type":"Field","children":[],"entity":"Products","alias":"p"}]},{"name":"__parentId","type":"KeyValue","children":[{"name":"id","type":"Field","children":[],"entity":"Products","alias":"p"}]}]}]}],"fields":[{"name":"id","type":"integer"},{"name":"name","type":"string"},{"name":"supplierId","type":"integer"},{"name":"categoryId","type":"integer"},{"name":"quantity","type":"string"},{"name":"price","type":"decimal"},{"name":"inStock","type":"decimal"},{"name":"onOrder","type":"decimal"},{"name":"reorderLevel","type":"decimal"},{"name":"discontinued","type":"boolean"},{"name":"__parentId","type":"integer"}],"parameters":[{"name":"__parentId","type":"array"}],"entity":"Products"}],"relation":{"name":"product","from":"productId","entity":"Products","to":"id","target":"orderDetails","type":"oneToMany","weak":false}}],"fields":[{"name":"quantity","type":"decimal"},{"name":"unitPrice","type":"decimal"},{"name":"productId","type":"integer"},{"name":"__productId","type":"integer"},{"name":"__parentId","type":"integer"}],"parameters":[{"name":"__parentId","type":"array"}],"entity":"OrderDetails"}],"relation":{"name":"details","type":"manyToOne","composite":true,"from":"id","entity":"OrderDetails","weak":true,"to":"orderId","target":"order"}},{"name":"customer","type":"SentenceInclude","children":[{"name":"select","type":"Sentence","children":[{"name":"filter","type":"Filter","children":[{"name":"includes","type":"FunctionRef","children":[{"name":"id","type":"Field","children":[],"entity":"Customers","alias":"c"},{"name":"__parentId","type":"Variable","children":[],"number":1}]}]},{"name":"Customers.c","type":"From","children":[]},{"name":"map","type":"Map","children":[{"name":"obj","type":"Obj","children":[{"name":"id","type":"KeyValue","children":[{"name":"id","type":"Field","children":[],"entity":"Customers","alias":"c"}]},{"name":"name","type":"KeyValue","children":[{"name":"name","type":"Field","children":[],"entity":"Customers","alias":"c"}]},{"name":"contact","type":"KeyValue","children":[{"name":"contact","type":"Field","children":[],"entity":"Customers","alias":"c"}]},{"name":"phone","type":"KeyValue","children":[{"name":"phone","type":"Field","children":[],"entity":"Customers","alias":"c"}]},{"name":"address","type":"KeyValue","children":[{"name":"address","type":"Field","children":[],"entity":"Customers","alias":"c"}]},{"name":"city","type":"KeyValue","children":[{"name":"city","type":"Field","children":[],"entity":"Customers","alias":"c"}]},{"name":"region","type":"KeyValue","children":[{"name":"region","type":"Field","children":[],"entity":"Customers","alias":"c"}]},{"name":"postalCode","type":"KeyValue","children":[{"name":"postalCode","type":"Field","children":[],"entity":"Customers","alias":"c"}]},{"name":"country","type":"KeyValue","children":[{"name":"country","type":"Field","children":[],"entity":"Customers","alias":"c"}]},{"name":"__parentId","type":"KeyValue","children":[{"name":"id","type":"Field","children":[],"entity":"Customers","alias":"c"}]}]}]}],"fields":[{"name":"id","type":"string"},{"name":"name","type":"string"},{"name":"contact","type":"string"},{"name":"phone","type":"string"},{"name":"address","type":"string"},{"name":"city","type":"string"},{"name":"region","type":"string"},{"name":"postalCode","type":"string"},{"name":"country","type":"string"},{"name":"__parentId","type":"string"}],"parameters":[{"name":"__parentId","type":"array"}],"entity":"Customers"}],"relation":{"name":"customer","from":"customerId","entity":"Customers","to":"id","target":"orders","targetComposite":true,"type":"oneToMany","weak":false}}],"fields":[{"name":"id","type":"integer"},{"name":"customerId","type":"string"},{"name":"employeeId","type":"integer"},{"name":"orderDate","type":"datetime"},{"name":"requiredDate","type":"datetime"},{"name":"shippedDate","type":"datetime"},{"name":"shipViaId","type":"integer"},{"name":"freight","type":"decimal"},{"name":"name","type":"string"},{"name":"address","type":"string"},{"name":"city","type":"string"},{"name":"region","type":"string"},{"name":"postalCode","type":"string"},{"name":"country","type":"string"},{"name":"__id","type":"integer"},{"name":"__customerId","type":"string"}],"parameters":[{"name":"id","type":"integer"}],"entity":"Orders"}
		const constraintsExpected :any= {"entity":"Orders","constraints":[],"childs":[{"entity":"OrderDetails","constraints":[],"childs":[{"entity":"Products","constraints":[]}]},{"entity":"Customers","constraints":[]}]}
		const model = orm.model(expression)
		const parameters = orm.parameters(expression)
		const constraints = orm.constraints(expression)
		const metadata = orm.metadata(expression)
		expect(modelExpected).toStrictEqual(model)
		expect(metadataExpected.fields).toStrictEqual(metadata.fields)
		expect(parametersExpected).toStrictEqual(parameters)
		expect(constraintsExpected).toStrictEqual(constraints)
	})
	test('include 8', async () => {
		const expression = 'Orders.filter(p=>(p.id===id)).include(p=>[p.customer.map(p=>p.name),p.details.include(p=>p.product.include(p=>p.category.map(p=>p.name)).map(p=>p.name)).map(p=>[p.quantity,p.unitPrice])])'
		const modelExpected :any= [{"name":"id","type":"integer"},{"name":"customerId","type":"string"},{"name":"employeeId","type":"integer"},{"name":"orderDate","type":"datetime"},{"name":"requiredDate","type":"datetime"},{"name":"shippedDate","type":"datetime"},{"name":"shipViaId","type":"integer"},{"name":"freight","type":"decimal"},{"name":"name","type":"string"},{"name":"address","type":"string"},{"name":"city","type":"string"},{"name":"region","type":"string"},{"name":"postalCode","type":"string"},{"name":"country","type":"string"},{"name":"customer","type":"Customers","childs":[{"name":"name","type":"string"}]},{"name":"details","type":"OrderDetails[]","childs":[{"name":"quantity","type":"decimal"},{"name":"unitPrice","type":"decimal"},{"name":"product","type":"Products","childs":[{"name":"name","type":"string"},{"name":"category","type":"Categories","childs":[{"name":"name","type":"string"}]}]}]}]
		const parametersExpected:any = [{"name":"id","type":"integer"},{"name":"customer","type":"Customers","childs":[{"name":"__parentId","type":"array"}]},{"name":"details","type":"OrderDetails","childs":[{"name":"__parentId","type":"array"},{"name":"product","type":"Products","childs":[{"name":"__parentId","type":"array"},{"name":"category","type":"Categories","childs":[{"name":"__parentId","type":"array"}]}]}]}]
		const metadataExpected :any= {"name":"select","type":"Sentence","children":[{"name":"filter","type":"Filter","children":[{"name":"===","type":"Operator","children":[{"name":"id","type":"Field","children":[],"entity":"Orders","alias":"o"},{"name":"id","type":"Variable","children":[],"number":1}]}]},{"name":"Orders.o","type":"From","children":[]},{"name":"map","type":"Map","children":[{"name":"obj","type":"Obj","children":[{"name":"id","type":"KeyValue","children":[{"name":"id","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"customerId","type":"KeyValue","children":[{"name":"customerId","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"employeeId","type":"KeyValue","children":[{"name":"employeeId","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"orderDate","type":"KeyValue","children":[{"name":"orderDate","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"requiredDate","type":"KeyValue","children":[{"name":"requiredDate","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"shippedDate","type":"KeyValue","children":[{"name":"shippedDate","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"shipViaId","type":"KeyValue","children":[{"name":"shipViaId","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"freight","type":"KeyValue","children":[{"name":"freight","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"name","type":"KeyValue","children":[{"name":"name","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"address","type":"KeyValue","children":[{"name":"address","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"city","type":"KeyValue","children":[{"name":"city","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"region","type":"KeyValue","children":[{"name":"region","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"postalCode","type":"KeyValue","children":[{"name":"postalCode","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"country","type":"KeyValue","children":[{"name":"country","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"__customerId","type":"KeyValue","children":[{"name":"customerId","type":"Field","children":[],"entity":"Orders","alias":"o"}]},{"name":"__id","type":"KeyValue","children":[{"name":"id","type":"Field","children":[],"entity":"Orders","alias":"o"}]}]}]},{"name":"customer","type":"SentenceInclude","children":[{"name":"select","type":"Sentence","children":[{"name":"filter","type":"Filter","children":[{"name":"includes","type":"FunctionRef","children":[{"name":"id","type":"Field","children":[],"entity":"Customers","alias":"c"},{"name":"__parentId","type":"Variable","children":[],"number":1}]}]},{"name":"Customers.c","type":"From","children":[]},{"name":"map","type":"Map","children":[{"name":"obj","type":"Obj","children":[{"name":"name","type":"KeyValue","children":[{"name":"name","type":"Field","children":[],"entity":"Customers","alias":"c"}]},{"name":"__parentId","type":"KeyValue","children":[{"name":"id","type":"Field","children":[],"entity":"Customers","alias":"c"}]}]}]}],"fields":[{"name":"name","type":"string"},{"name":"__parentId","type":"string"}],"parameters":[{"name":"__parentId","type":"array"}],"entity":"Customers"}],"relation":{"name":"customer","from":"customerId","entity":"Customers","to":"id","target":"orders","targetComposite":true,"type":"oneToMany","weak":false}},{"name":"details","type":"SentenceInclude","children":[{"name":"select","type":"Sentence","children":[{"name":"filter","type":"Filter","children":[{"name":"includes","type":"FunctionRef","children":[{"name":"orderId","type":"Field","children":[],"entity":"OrderDetails","alias":"o1"},{"name":"__parentId","type":"Variable","children":[],"number":1}]}]},{"name":"OrderDetails.o1","type":"From","children":[]},{"name":"map","type":"Map","children":[{"name":"obj","type":"Obj","children":[{"name":"quantity","type":"KeyValue","children":[{"name":"quantity","type":"Field","children":[],"entity":"OrderDetails","alias":"o1"}]},{"name":"unitPrice","type":"KeyValue","children":[{"name":"unitPrice","type":"Field","children":[],"entity":"OrderDetails","alias":"o1"}]},{"name":"__productId","type":"KeyValue","children":[{"name":"productId","type":"Field","children":[],"entity":"OrderDetails","alias":"o1"}]},{"name":"__parentId","type":"KeyValue","children":[{"name":"orderId","type":"Field","children":[],"entity":"OrderDetails","alias":"o1"}]}]}]},{"name":"product","type":"SentenceInclude","children":[{"name":"select","type":"Sentence","children":[{"name":"filter","type":"Filter","children":[{"name":"includes","type":"FunctionRef","children":[{"name":"id","type":"Field","children":[],"entity":"Products","alias":"p"},{"name":"__parentId","type":"Variable","children":[],"number":1}]}]},{"name":"Products.p","type":"From","children":[]},{"name":"map","type":"Map","children":[{"name":"obj","type":"Obj","children":[{"name":"name","type":"KeyValue","children":[{"name":"name","type":"Field","children":[],"entity":"Products","alias":"p"}]},{"name":"__categoryId","type":"KeyValue","children":[{"name":"categoryId","type":"Field","children":[],"entity":"Products","alias":"p"}]},{"name":"__parentId","type":"KeyValue","children":[{"name":"id","type":"Field","children":[],"entity":"Products","alias":"p"}]}]}]},{"name":"category","type":"SentenceInclude","children":[{"name":"select","type":"Sentence","children":[{"name":"filter","type":"Filter","children":[{"name":"includes","type":"FunctionRef","children":[{"name":"id","type":"Field","children":[],"entity":"Categories","alias":"c1"},{"name":"__parentId","type":"Variable","children":[],"number":1}]}]},{"name":"Categories.c1","type":"From","children":[]},{"name":"map","type":"Map","children":[{"name":"obj","type":"Obj","children":[{"name":"name","type":"KeyValue","children":[{"name":"name","type":"Field","children":[],"entity":"Categories","alias":"c1"}]},{"name":"__parentId","type":"KeyValue","children":[{"name":"id","type":"Field","children":[],"entity":"Categories","alias":"c1"}]}]}]}],"fields":[{"name":"name","type":"string"},{"name":"__parentId","type":"integer"}],"parameters":[{"name":"__parentId","type":"array"}],"entity":"Categories"}],"relation":{"name":"category","from":"categoryId","entity":"Categories","to":"id","target":"products","type":"oneToMany","weak":false}}],"fields":[{"name":"name","type":"string"},{"name":"__categoryId","type":"integer"},{"name":"__parentId","type":"integer"}],"parameters":[{"name":"__parentId","type":"array"}],"entity":"Products"}],"relation":{"name":"product","from":"productId","entity":"Products","to":"id","target":"orderDetails","type":"oneToMany","weak":false}}],"fields":[{"name":"quantity","type":"decimal"},{"name":"unitPrice","type":"decimal"},{"name":"__productId","type":"integer"},{"name":"__parentId","type":"integer"}],"parameters":[{"name":"__parentId","type":"array"}],"entity":"OrderDetails"}],"relation":{"name":"details","type":"manyToOne","composite":true,"from":"id","entity":"OrderDetails","weak":true,"to":"orderId","target":"order"}}],"fields":[{"name":"id","type":"integer"},{"name":"customerId","type":"string"},{"name":"employeeId","type":"integer"},{"name":"orderDate","type":"datetime"},{"name":"requiredDate","type":"datetime"},{"name":"shippedDate","type":"datetime"},{"name":"shipViaId","type":"integer"},{"name":"freight","type":"decimal"},{"name":"name","type":"string"},{"name":"address","type":"string"},{"name":"city","type":"string"},{"name":"region","type":"string"},{"name":"postalCode","type":"string"},{"name":"country","type":"string"},{"name":"__customerId","type":"string"},{"name":"__id","type":"integer"}],"parameters":[{"name":"id","type":"integer"}],"entity":"Orders"}
		const constraintsExpected :any= {"entity":"Orders","constraints":[],"childs":[{"entity":"Customers","constraints":[]},{"entity":"OrderDetails","constraints":[],"childs":[{"entity":"Products","constraints":[],"childs":[{"entity":"Categories","constraints":[]}]}]}]}
		const model = orm.model(expression)
		const parameters = orm.parameters(expression)
		const constraints = orm.constraints(expression)
		const metadata = orm.metadata(expression)
		expect(modelExpected).toStrictEqual(model)
		expect(metadataExpected.fields).toStrictEqual(metadata.fields)
		expect(parametersExpected).toStrictEqual(parameters)
		expect(constraintsExpected).toStrictEqual(constraints)
	})
})
describe('Sentences', () => {
	test('include 1', async () => {
		const expression = 'Orders.filter(p=>(p.id===id)).include(p=>p.customer)'
	})
	test('include 2', async () => {
		const expression = 'Orders.filter(p=>(p.id===id)).include(p=>p.details)'
	})
	test('include 3', async () => {
		const expression = 'Orders.filter(p=>(p.id===id)).include(p=>[p.details,p.customer])'
	})
	test('include 4', async () => {
		const expression = 'Orders.filter(p=>(p.id===id)).include(p=>[p.details.include(q=>q.product),p.customer])'
	})
	test('include 5', async () => {
		const expression = 'Orders.filter(p=>(p.id===id)).include(p=>[p.details.include(q=>q.product.include(p=>p.category)),p.customer])'
	})
	test('include 6', async () => {
		const expression = 'Orders.filter(p=>(p.id===id)).include(p=>[p.details.map(p=>{quantity:p.quantity,unitPrice:p.unitPrice,productId:p.productId}),p.customer])'
	})
	test('include 7', async () => {
		const expression = 'Orders.filter(p=>(p.id===id)).include(p=>[p.details.include(q=>q.product).map(p=>{quantity:p.quantity,unitPrice:p.unitPrice,productId:p.productId}),p.customer])'
	})
	test('include 8', async () => {
		const expression = 'Orders.filter(p=>(p.id===id)).include(p=>[p.customer.map(p=>p.name),p.details.include(p=>p.product.include(p=>p.category.map(p=>p.name)).map(p=>p.name)).map(p=>[p.quantity,p.unitPrice])])'
	})
})